services:
  nginx:
    image: nginx:stable
    ports:
      - "8080:80"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d
    depends_on:
      - backend
      - frontend

  backend:
    image: ghcr.io/kencopas/backend:latest
    expose:
      - "8000"

  frontend:
    image: ghcr.io/kencopas/frontend:latest
    expose:
      - "80"
  
  webhook:
    build: ./webhook
    environment:
      - WEBHOOK_SECRET=${WEBHOOK_SECRET}
      - DEPLOY_SCRIPT=/infra/scripts/deploy.sh
      - ALLOWED_REF=refs/heads/main
    volumes:
      - ./scripts:/infra/scripts:ro
      - /var/run/docker.sock:/var/run/docker.sock
    expose:
      - "9001"
